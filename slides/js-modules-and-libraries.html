<html lang="de">
  <!DOCTYPE html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>JS Module und Bibliotheken</title>

    <link rel="stylesheet" href="revealjs/reveal.js/dist/reset.css" />
    <link rel="stylesheet" href="revealjs/reveal.js/dist/reveal.css" />
    <link rel="stylesheet" href="revealjs/reveal.js/dist/theme/solarized.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="revealjs/highlight-js-github-theme.css" />
    <link rel="stylesheet" href="revealjs/styles.css" />
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-state="title">
          <h2 class="title" style="font-size: 7rem">
            <b>JS Module und Bibliotheken</b>
          </h2>

          <h4>
            <span class="transparent-bg">
              <a href="https://nilshartmann.net" target="_blank"
                >Nils Hartmann</a
              >
              |
              <a href="https://twitter.com/nilshartmann" target="_blank"
                >@nilshartmann</a
              >
            </span>
          </h4>

          <p style="margin-top: 4rem"></p>
          <div>
            <h3><span class="transparent-bg">Slides</span></h3>
            <p>
              <span class="transparent-bg"
                >Lokal: slides/js-modules-and-libraries.html</span
              >
            </p>
          </div>
        </section>
        <section>
          <h2>Nils Hartmann</h2>
          <p>
            <a href="https://nilshartmann.net" target="_blank"
              >https://nilshartmann.net</a
            >
            /
            <a href="https://twitter.com/nilshartmann" target="_blank"
              >@nilshartmann</a
            >
          </p>
          <p>
            <em
              >Freiberuflicher Software-Entwickler, Berater und Trainer aus
              Hamburg</em
            >
          </p>

          <div style="display: flex; justify-content: center">
            <div>
              <p>Java</p>
              <p>JavaScript, TypeScript</p>
              <p>React</p>
              <p>Single-Page-Applications</p>
              <p>GraphQL</p>
              <p style="margin-top: 20px">
                <a href="https://nilshartmann.net/workshops"
                  >Schulungen und Workshops</a
                >
              </p>
            </div>
            <div style="margin-left: 15px">
              <a href="https://reactbuch.de"
                ><img
                  style="max-height: 450px"
                  src="images/react-buch-v2.jpg"
                /><br />https://reactbuch.de</a
              >
              <br />
            </div>
          </div>
        </section>

        <section data-markdown>
          <textarea data-template>
# Agenda

* Teil 1: "Basis"
  * Package Manager
  * Modul-Systeme in JavaScript
    * Node.JS vs. Browser
    * Besonderheiten: TypeScript und React/JSX
  * Workspaces und Mono Repos

* Teil 2: Verwaltung von Abh√§ngigkeiten
 * Releases erstellen
 * 3rd-Party-Libs (Updates, Lizenzen, Sicherheitsprobleme)

---

## Packages und Module

![Packages und Module](./images/packages-und-module.png)

---

## Package Manager, Aufgaben I

### Installation von Packages
* Probleme / Herausforderungen
  * Aufl√∂sen der Dependencies (Packages, die andere Packages ben√∂tigen)
  * Runterladen und lokales Speichern der Packages
    * muss in einem Format passieren, das von NodeJS verstanden wird
  * _Performance_ bei Package-Managern bezieht sich in der Regel auf diese beiden Punkte (Installation/Upgrade von Packages)  
  * Lock-Files um "einzufrieren", welche Packages in welcher Version von welcher Quelle installiert wurden
   - Erm√∂glicht reproduzierbare Builds
  * Zugriff nur auf Packages, die in der `package.json`-Datei beschrieben sind und nicht auf transiente Abh√§ngigkeiten.
* Scripte
  * Ausf√ºhren lokaler Skripte, z.B. zum Starten einer Anwendung (`scripts` in `package.json`)
  
---

## Package Manager, Aufgaben II

### Workspace-Konzept
 * Mehrere Packages lokal im Workspace/Repository
 * Ziele: 
   - Vermindern von mehrfacher Installation derselben Packages
   - Ausf√ºhren von Scripts in mehreren Packages
   - Lokales Arbeiten mit Packages vereinfachen (lokales Package A kann direkt lokales Package B verwenden)

---

## √úbersicht Package Manager

* npm - Klassiker, in Node enthalten
* [yarn ("classic")](https://classic.yarnpkg.com/lang/en/) - war mal schneller als npm und hatte als erstes `.lock`-Dateien und Workspace-Konzept
* [yarn 2/3 ("berry")](https://yarnpkg.com/) 
  - "zero install": Installierte Packages k√∂nnen eingecheckt werden, m√ºssen dann nicht installiert werden (optional)
  - "plug-n-play":  Packages werden in _einer_ Datei und nicht in `node_modules` abgelegt
    - Das muss dann in allen Tools funktionieren, z.B. auch IDEs, TypeScript oder Webpack
    - Yarn z.B. greift dazu in den resolution-Prozess ein (und [patched TypeScript beim Installieren](https://github.com/yarnpkg/berry/tree/master/packages/plugin-compat)!) üò±
    - Node-Prozesse m√ºssen √ºber `scripts` ausgef√ºhrt werden
      - oder Anwendungen [angepasst werden](https://yarnpkg.com/features/pnp#initializing-pnp)
    - Kann per [nodeLinker-Konfiguration](https://yarnpkg.com/configuration/yarnrc#nodeLinker) umgestellt werden auf `node_modules`  
  - Dependency-Regeln mit Prolog
* [pnpm](https://pnpm.io) - "performant" npm
 - Dateien im node_modules-Verzeichnis werden verlinkt
 - Package m√ºssen daher nur einmal lokal installiert werden
* [corepack](https://nodejs.org/dist/latest/docs/api/corepack.html) (_experimentell_) 
  - kein Packagemanager, sondern "Proxy" in Node, um transparent (ohne Installation) den Package-Manager eines Projekts zu verwenden
* Beispiele: https://github.com/nilshartmann/package-manager-playground

---

## Package-Manager: Nur direkte Packages verwenden

* `npm` und `yarn` sowie `yarn berry` ohne pnp erlauben die Verwendung von Packages, die nicht direkt in die package.json-Datei eingetragen sind
  - transitive Dependencies
* `pnpm` und `yarn berry` mit pnp stellen sicher, dass man nur Abh√§ngigkeiten verwendet, die auch in der `package.json`-Datei aufgef√ºhrt sind.  

---

# Modul-Systeme in JavaScript

---

## Modul-Systeme

### Es gibt mehrere Modulsysteme in JS

* [CommonJS](https://nodejs.org/docs/latest/api/modules.html) (Node)
* [ECMAScript Modules (ESM)](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules)
  * CommonJS der Klassiker in/f√ºr NodeJS
  * ESM erst seit ES2015
  * Verbreiteter Support f√ºr ESM in Browsern und Node noch recht neu (Node stabil seit Version 12, Ende 2019)

---

## Modul-Systeme: Probleme 

### Zugriff/Verwendung der Module

* Module m√ºssen zur Laufzeit gefunden werden
  * CommonJS l√§uft nicht im Browser üòø
  * (u.a.) deswegen verwenden wir Bundlor (Webpack, Rollup)
  * Dann m√ºssen die Module auch zur Buildzeit gefunden werden
 * Module m√ºssen zur Buildzeit gefunden werden
  * (F√ºr Bundlor)
  * F√ºr TypeScript, mindestens die Type Declarations
  * F√ºr IDE-Support
  * ...

---

## Modul-Systeme: Probleme 

### Zugriff/Verwendung der Module
  
* Eine Anwendung m√∂chte evtl. beide Modulsysteme nutzen
  * Zumindest indirekt √ºber eingebundene Bibliotheken
* Modul-Systeme verhalten sich unterschiedlich ü•≥
  * CommonJS: synchrone imports, ESM ist asynchron 
  * **CommonJS-Module k√∂nnen keine ESM-Module verwenden!**
  * TypeScript erzeugt per Default aber CommonJS-Code
* Einige Bibliotheken stehen als JS, andere als TS zur Verf√ºgung
* (Diese Probleme sind unabh√§ngig davon, ob man Mono-Repo verwendet oder nicht)

---

## Modul-Systeme: Konfiguration 


### Package.json

* `type`: `module` oder  `commonsjs`
  * gibt an, welches Modulsystem das Package (per Default) verwendet
* `main`: diese Datei wird beim import/require des Moduls verwendet **deprecated**
* `exports`: (https://nodejs.org/api/packages.html#exports)
  * `exports: dateiname.js: entspricht ehem `main`
  * oder "conditional exports", hier k√∂nnen Pfade pro Modulsystem angegeben weden:
  * `exports: { "import": "./index.mjs", "require": "./index.cjs" }`
  * Auf Dateiendung bei "hybriden"-Modulen achten:
    * wenn als `type: module` gesetzt ist, werden **alle** Dateien, die mit `.js`-Enden als
      ESM-Dateien angesehen, auch wenn sie als `require` unter `exports` aufgef√ºhrt werden ü§¶
  * au√üerdem k√∂nnen mehrere Pfade exportiert werden
  * https://nodejs.org/api/packages.html#conditional-exports

---

## Modul-Systeme: Konfiguration

* In der `tsconfig` kann gesteuert werden, welches Modul-Format TypeScript erzeugt:
  * `"module": "ES2020"` oder `"module": "ESNext": ESM
  * `"module": "commonjs"`": CommonJS (default)
* Wenn man als als Modulsystem ESM konfiguriert, m√ºssen die Importe Dateiendungen haben:
  * `import x from "./x.js"
  * Hier auch `.js` obwohl `x` m√∂glicherweise ein TypeScript-Modul ist ...  


---

## Bundler I

### Das Modulsystem ist nur ein Teil im Tool-Stack...
  * JavaScript, 2 Modulsysteme
  * TypeScript/Babel
  * CSS/PostCSS/CSS Modules/Sass
  * Json, SVG/PNG
  * Hot Reload/Fast Refresh w√§hrend Entwicklung
  * Code Splitting / Tree Shaking
* Wie wird getestet?

---

## Bundler II

### Typische Vertreter
* Webpack: Klassiker, in create-react-app enthalten
* Rollup: bietet sich insbesondere f√ºr Bibliotheken an
* esbuild (in Go geschrieben, sehr schnell)

---

### Bundler

### ESbuild: die Zukunft?

* In Go geschrieben, arbeitet parallel deswegen sehr schnell
* Funktioniert auch als Compiler (?), verwendet jedenfalls kein Babel
  * Bessere Performance als Webpack (webpack parsed zweimal: Babel und dann Webpack)
  * Man kann aber nicht alle Babel-Features (Plugins) nutzen
* Bundling funktioniert noch nicht richtig
  * Code-Splitting nur mit ESM-Modules z.B.
  * deswegen verwendet Vite ESBuild nur  zur Entwicklungszeit

---

## Workspaces / Mono-Repos

### Anforderungen:
* Ausf√ºhren von Scripts in allen Packages (z.B. "install" oder "build")
* Doppelte Packages sollen nach M√∂glichkeit nicht doppelt installiert werden
  * Zum Beispiel wenn selbe React-Version in mehreren Packages verwendet wird
* wenn wir mehrere Packages entwickeln, wollen wir die m√∂glichst lokal haben,
  um sie einfach verwenden, testen und √§ndern zu k√∂nnen
  * Roundtrip: publish -> install w√§re zu lang
* Packages m√ºssen u.U. erst gebaut werden (TypeScript, Webpack, Roll-up, ...), bevor wir sie benutzen k√∂nnen
  * Wer steuert, wann welches Package gebaut werden muss?
  * √Ñnderung in Package A, das von B benutzt wird: Package B tests neu ausf√ºhren? Package B neu bauen?

---

## Workspaces / Mono-Repos

* Workspaces werden von allen Package-Managern mittlerweile unterst√ºtzt
  * npm, yarn, pnpm
  * In der Regel bezieht sich das auf zentrale Installation von Abh√§ngigkeiten

---

## Lerna

* Der Klassiker der Mono-Repo-Tools 
  * Installation von Dependencies
  * Publishing von neuen Packages
* Erst ["not actively maintained"](https://github.com/lerna/lerna/commit/8b99493ac90484e05f7ebee533c0763534d60218)...
* ...dann von [nrwl √ºbernommen](https://github.com/lerna/lerna/issues/3121)
* Was das f√ºr die [Zukunft von Lerna](https://blog.nrwl.io/lerna-is-dead-long-live-lerna-61259f97dbd9) bedeutet, ist mir nicht klar 
* Alternativen
  * [workspace-tools Plug-in](https://github.com/yarnpkg/berry/blob/HEAD/packages/plugin-workspace-tools/README.md) von Yarn 2
  * ?

---

## Workspace und MonoRepos

* Problem: Peformance und Architektur

* Wenn wir viele Packages in einem Monorepo haben, wollen wir die nicht alle
  neu bauen, wenn wir eins ver√§ndert haben
* Nur die abh√§ngigen neu bauen (und ggf. testen)
* Dazu gibt es spezialisierte Tools wie Nx oder Turborepo
* Diese f√ºgen z.B. einen Build-Cache hinzu
* Und weiteres Tooling (z.B. VS Code Extension f√ºr NX)
* Architektur-Visualisierung

---

## Mono-Repo: Tools

### TurboRepo

* "Nur" Task-Runner
* Man definiert eine Pipeline
  * Beschreibt, in welcher Reihenfolge welche Packages gebaut werden m√ºssen 
  * wie die Packages gebaut werden m√ºssen
  * Die Tasks k√∂nnen parallel laufen (!)
  * Caching von Ergebnissen so dass nur √Ñnderungen neu gebaut werden m√ºssen
  * "Remote Caching": Ergebnisse werden in der Cloud gecached (Vercel Cloud oder - theoretisch [eigene](https://turborepo.org/docs/core-concepts/remote-caching#custom-remote-caches)). Beta!
* Wie die einzelnen Packages gebaut werden, entscheidet jedes Package selbst (z.B. mit create-react-app)
* Kein Workflow zum Ver√∂ffentlichen von Packages. In der Doku wird daf√ºr auf Lerna verwiesen...

---

## Mono-Repo: Tools

### NX

* [https://nx.dev/](https://nx.dev/)
* Workspaces bestehen aus Anwendungen und Bibliotheken
* Code-Generatoren erzeugen Boilerblate-Code f√ºr alles m√∂gliche
  * Zum Beispiel React Apps, UI Libs, Tests
  * Unter der Haube wird f√ºr React wohl Webpack verwendet
  * Plug-ins f√ºr [einige Editoren](https://nx.dev/using-nx/console)
* Bibliotheken sind per Default nicht f√ºr "standalone-publishing" gedacht
  * man kann sie aber explizt [so konfigurieren](https://nx.dev/structure/buildable-and-publishable-libraries#publishable-libraries)
* Build-Artefakte k√∂nnen in NX Cloud geteilt werden, die [privat gehostet](https://nx.app/docs/get-started-with-private-cloud-community) werden kann
  
---

## Rush

* [https://rushjs.io/](https://rushjs.io/) von Microsoft
* Einenaussage: geeignet f√ºr sehr gro√üe Monorepos
* Benutzt pnpm 
* Support f√ºr inkremtental Builds und Publishing von Packages
  * F√ºhrt zum Build einfach `npm run build` in jedem Package aus
  * Was man dabei macht, ist einem selbst √ºberlassen
* [Remote Cache](https://rushjs.io/pages/maintainer/build_cache/#enabling-cloud-storage) f√ºr Build-Artefakte (Beta)
 * Support f√ºr Azure und S3
 * Theoretisch eigene via Plug-in m√∂glich  

---

## Arbeiten mit Applikationen

### Anforderungen
* Hot-Refresh
* Test-support

---

## Arbeiten mit Applikationen

### Tools
* create-react-app (bekannt)
* NX (schon gesehen)
* https://vitejs.dev/
 * benutzt unter der haube es esbuild (nur zur Entwicklungszeit), ansonten Rollup
 * sehr schnell
 * leider eigenes Test-Tool [Vitest](https://vitest.dev/)
   * [vite-jest](https://github.com/sodatea/vite-jest#readme) sieht eher verloren aus


---

## Empfehlung

* Die ganze Modul/MonoRepo-Szene ist sehr fragmentiert und fragil
* In einem Stack muss immer alles mit allem zusammenspielen 
* M√∂glichst auf Mainstream setzen
* So wenig Tooling wie m√∂glich

---

# Verwaltung von Abh√§ngigkeiten

---

## Sicherheitspr√ºfungen

* `npm audit`
  * auch in [Nexus integriert](https://help.sonatype.com/repomanager3/nexus-repository-administration/formats/npm-registry/npm-audit) (eventuell nur mit Nexus IQ)
* [OWASP dependency-check](https://github.com/jeremylong/DependencyCheck) 
 * Integration u.a. in [Jenkins](https://plugins.jenkins.io/dependency-check-jenkins-plugin/) und [Sonarqube](https://github.com/dependency-check/dependency-check-sonar-plugin)

---

## Abh√§ngigkeitsmanagement

* [Renovate](https://docs.renovatebot.com/): erzeugt Pull Requests f√ºr veraltete Dependecies
  * Kann selbst gehostet werden
* [Dependabot](https://github.com/dependabot), Pull Requests f√ºr GitHub
  * [dependabot-gitlab](https://gitlab.com/dependabot-gitlab/dependabot): Fork/Klon/Kopie f√ºr GitLab
* [CycloneDX](https://cyclonedx.org/): Erzeugt einen Software Bill-of-Material (sbom) f√ºr ein Java/Node/...-Projekt
  * Es gibt Support f√ºr diverse [Tools, Sprachen etc.](https://cyclonedx.org/tool-center/)
* Der SBOM kann in [Dependency Track](https://dependencytrack.org/) eingelesen werden
*  DT kann bestimmte Pr√ºfungen durchf√ºhren: Verwendete Lizenzen, Security Alerts
  * Integration in [Jenkins mittels Plugin](https://plugins.jenkins.io/dependency-track/)

---

## Releases  

* [semantic-release](https://github.com/semantic-release/semantic-release): Erzeugt Releases mit Versionsnummern, Git Tags und Changelog an Hand von [Commit Message Konventionen](https://github.com/semantic-release/semantic-release#commit-message-format)
  * Insbesondere [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/)
* [Commitizen](https://commitizen-tools.github.io/commitizen/): Erzwingt Commit-Kommentare in bestimmten Format, selbst definiert oder Convential Commits

          </textarea>
        </section>
        <section>
          <h2>Geschafft! üòä</h2>
          <h3>Vielen Dank f√ºr Eure Teilnahme!</h3>
          <p>Wenn ihr noch Fragen habt, k√∂nnt ihr mich erreichen:</p>
          <p>
            <a href="mailto:nils@nilshartmann.net">nils@nilshartmann.net</a>
          </p>
          <p>
            <a href="https://nilshartmann.net" target="_blank"
              >https://nilshartmann.net</a
            >
          </p>
          <p>
            <a
              href="https://www.xing.com/profile/Nils_Hartmann2/cv"
              target="_blank"
              >Xing</a
            >
          </p>

          <p>
            Twitter:
            <a href="https://twitter.com/nilshartmann" target="_blank"
              >@nilshartmann</a
            >
          </p>
        </section>
      </div>
    </div>
    <script src="revealjs/reveal.js/dist/reveal.js"></script>
    <script src="revealjs/reveal.js/plugin/notes/notes.js"></script>
    <script src="revealjs/reveal.js/plugin/markdown/markdown.js"></script>
    <script src="revealjs/reveal.js/plugin/highlight/highlight.js"></script>
    <script src="revealjs/config.js"></script>
  </body>
</html>
